---
import BaseLayout from './BaseLayout.astro';
import Container from '../components/shell/Container.astro';
import ContentGrid from '../components/layout/ContentGrid.astro';
import Button from '../components/ui/Button.astro';
import Heading from '../components/ui/Heading.astro';
import Text from '../components/ui/Text.astro';
import StickyNav from '../components/navigation/StickyNav.astro';
import MediaFrame from '../components/patterns/MediaFrame.astro';
import { Image } from 'astro:assets';
import type { ProjectSection } from '../components/projects';

export interface Action {
  label: string;
  href: string;
  variant?: 'primary' | 'secondary' | 'ghost' | 'link';
}

export interface Props {
  title: string;
  description?: string;
  eyebrow?: string;
  heroImage?: string;
  heroAlt?: string;
  techStack?: string[];
  actions?: Action[];
  navLinks?: { href: string; label: string }[];
  sections?: ProjectSection[];
  toc?: { id: string; label: string }[];
}

const props = Astro.props as Props;

const {
  title,
  description,
  eyebrow,
  heroImage,
  heroAlt,
  techStack = [],
  actions = [],
  navLinks = [],
  sections = [],
  toc,
} = props;

const heroIsGif = typeof heroImage === 'string' && heroImage.toLowerCase().endsWith('.gif');
const sectionAnchors = sections.flatMap((section) => [
  { id: section.id, label: section.label },
  ...(section.anchors ?? []),
]);

const defaultToc = [{ id: 'details', label: 'Details' }, ...sectionAnchors];

const tocMap = new Map<string, string>();
for (const item of (toc ?? defaultToc)) {
  if (!tocMap.has(item.id)) {
    tocMap.set(item.id, item.label);
  }
}

const stickyNavItems = Array.from(tocMap.entries()).map(([id, label]) => ({
  href: `#${id}`,
  label,
}));

const hasStickyNav = stickyNavItems.length > 1;
---
<BaseLayout title={`${title} | Ryan Rumana`} description={description} navLinks={navLinks}>
  <main class="project">
    <section class="project__hero">
      <Container class="project__hero-inner">
        <div class="project__heading">
          {eyebrow && <p class="project__eyebrow">{eyebrow}</p>}
          <Heading level={1} size="3xl">{title}</Heading>
          {description && <Text size="lg" tone="muted">{description}</Text>}
          {actions.length > 0 && (
            <div class="project__actions">
              {actions.map((action) => (
                <Button href={action.href} variant={action.variant ?? 'primary'}>
                  {action.label}
                </Button>
              ))}
            </div>
          )}
        </div>
        {heroImage && (
          <MediaFrame class="project__media" bleed>
            {heroIsGif ? (
              <img src={heroImage} alt={heroAlt ?? ''} loading="lazy" />
            ) : (
              <Image
                src={heroImage}
                alt={heroAlt ?? ''}
                loading="lazy"
                width={1366}
                height={767}
                fit="cover"
              />
            )}
          </MediaFrame>
        )}
      </Container>
    </section>

    {techStack.length > 0 && (
      <Container id="tech" class="project__meta">
        <h2>Tech Stack</h2>
        <ul>
          {techStack.map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      </Container>
    )}

    <article class="project__content">
      <Container>
        <ContentGrid nav={hasStickyNav}>
          {hasStickyNav && <StickyNav slot="nav" items={stickyNavItems} />}
          <div class="project__content-inner">
            <slot />
            {sections.length > 0 && (
              <div class="project__sections">
                {sections.map((section, index) => {
                  const SectionComponent = section.component;
                  const sectionProps = section.props ?? {};
                  return <SectionComponent data-section-index={index} {...sectionProps} />;
                })}
              </div>
            )}
          </div>
        </ContentGrid>
      </Container>
    </article>
  </main>
</BaseLayout>

<style>
.project__hero {
  padding-block: var(--space-3xl);
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--color-primary-500) 66%, transparent),
    color-mix(in srgb, var(--color-accent-500) 62%, transparent)
  );
}

.project__hero-inner {
  display: grid;
  gap: var(--space-2xl);
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  align-items: center;
}

.project__heading {
  display: grid;
  gap: var(--space-md);
}

.project__eyebrow {
  font-size: var(--font-size-sm);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-weight: 600;
  color: var(--color-text-muted);
}

.project__actions {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-sm);
}

.project__meta {
  margin-block: var(--space-2xl);
  display: grid;
  gap: var(--space-sm);
  scroll-margin-top: clamp(4rem, 8vw, 6.5rem);
}

.project__meta ul {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-sm);
  list-style: none;
}

.project__meta li {
  padding: var(--space-2xs) var(--space-sm);
  border-radius: var(--radius-xs);
  background: transparent;
  color: var(--color-text-muted);
  font-weight: 500;
  font-size: var(--font-size-xs);
  letter-spacing: 0.02em;
}

.project__content {
  padding-block: var(--space-3xl);
}

.project__content-inner {
  display: grid;
  gap: var(--space-xl);
}

.project__content-inner > * {
  scroll-margin-top: clamp(4rem, 8vw, 6.5rem);
}

.project__sections {
  display: grid;
  gap: var(--space-2xl);
}

.project__sections > * {
  scroll-margin-top: clamp(4rem, 8vw, 6.5rem);
}

.project__content-inner :global(h2) {
  font-size: var(--font-size-2xl);
  font-weight: 700;
  color: var(--color-text-default);
}

.project__content-inner :global(p) {
  font-size: var(--font-size-md);
  line-height: var(--line-height-normal);
  color: var(--color-text-muted);
  max-width: 70ch;
}

html[data-theme='dark'] .project__hero {
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--color-primary-500) 72%, transparent),
    color-mix(in srgb, var(--color-accent-500) 68%, transparent)
  );
}

html[data-theme='dark'] .project__media {
  border: 1px solid var(--color-border-muted);
}

html[data-theme='dark'] .project__meta li {
  background: transparent;
  color: var(--color-text-muted);
}
</style>
