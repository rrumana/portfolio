---
import SectionShell from '../layout/SectionShell.astro';
import SurfaceCard from '../ui/SurfaceCard.astro';
import Heading from '../ui/Heading.astro';
import Text from '../ui/Text.astro';
import Button from '../ui/Button.astro';
import gameOfLifeScriptUrl from '../../scripts/game_of_life.js?url';

export interface Props {
  id?: string;
}

const props = Astro.props as Props;
const { id = 'demo' } = props;
---
<SectionShell
  id={id}
  title="Interactive Playground"
  description="Experiment with the reverse solver directly in the browser. Draw on the grid, rewind generations, or export runs as GIFsâ€”all powered by the Rust + WASM engine."
  accent
>
  <div class="gol-demo__layout">
    <div class="gol-demo__column">
      <SurfaceCard padding="lg" class="gol-demo__canvas">
        <div class="gol-demo__viewport">
          <canvas
            id="lifeCanvas"
            width="400"
            height="400"
            aria-label="Game of Life grid"
          ></canvas>
        </div>

        <dl class="gol-demo__stats">
          <div>
            <dt>Grid</dt>
            <dd><span id="gridSizeDisplay">Grid: 20x20</span></dd>
          </div>
          <div>
            <dt>Live cells</dt>
            <dd>
              <span id="liveCellsDisplay" aria-live="polite">Live cells: 0</span>
            </dd>
          </div>
        </dl>
      </SurfaceCard>

      <SurfaceCard padding="lg" class="gol-demo__panel">
        <Heading level={3} size="lg">Simulation controls</Heading>
        <div class="gol-buttons">
        <Button id="stepBtn" variant="secondary">Step Forward</Button>
        <Button id="backBtn" variant="secondary">Step Back</Button>
        <Button id="resetBtn" variant="secondary">Reset</Button>
        <Button id="multiStepBtn" variant="secondary">Multi-Step</Button>
        <Button id="recordBtn" variant="secondary">Record GIF</Button>
      </div>
        <div class="gol-input">
          <label for="speedRange">Speed</label>
          <input type="range" id="speedRange" min="50" max="1000" value="200" />
          <span id="delayDisplay">Frame Delay: 200ms</span>
        </div>
        <div class="gol-input">
          <label for="genInput">Generations per step</label>
          <input type="number" id="genInput" min="1" max="100" value="1" />
        </div>
      </SurfaceCard>
    </div>

    <div class="gol-demo__column">
      <SurfaceCard padding="lg" class="gol-demo__panel">
        <Heading level={3} size="lg">Text-to-pattern tools</Heading>
        <div class="gol-input">
          <label for="textInput">Generate from text</label>
          <input type="text" id="textInput" placeholder="Enter text to convert" />
        </div>
        <div class="gol-input">
          <label for="bufferSizeSlider">Buffer size</label>
          <input type="range" id="bufferSizeSlider" min="1" max="10" value="2" />
          <span id="bufferDisplay">2</span>
        </div>
        <Button id="generateTextBtn" variant="secondary">Generate</Button>
      </SurfaceCard>

      <SurfaceCard padding="lg" class="gol-demo__panel">
        <Heading level={3} size="lg">Import &amp; export</Heading>
        <div class="gol-file">
          <input type="file" id="fileInput" accept=".txt" hidden />
          <Button id="fileUploadBtn" variant="secondary">Upload Pattern</Button>
          <span id="fileName">No file selected</span>
        </div>
        <div id="dragDropArea" class="gol-drop" aria-label="Drag and drop area" tabindex="0">
          Drag &amp; drop pattern files here
        </div>
        <Button id="downloadBtn" variant="secondary">Download Pattern</Button>
      </SurfaceCard>
    </div>
  </div>
</SectionShell>

<script
  type="module"
  set:html={`import(${JSON.stringify(gameOfLifeScriptUrl)})
    .then(({ initGameOfLife }) => initGameOfLife())
    .catch((error) => {
      console.error('Failed to initialize Game of Life demo:', error);
    });`}
></script>

<style>
.gol-demo__layout {
  display: grid;
  gap: var(--space-2xl, 3rem);
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
  align-items: start;
}

.gol-demo__column {
  display: grid;
  gap: var(--space-2xl, 3rem);
}

.gol-demo__canvas {
  position: relative;
  padding: 0;
  background: transparent;
  border: none;
  box-shadow: none;
}

.gol-demo__intro {
  display: grid;
  gap: var(--space-sm, 0.75rem);
}

.gol-demo__viewport {
  background: none;
  border-radius: 0;
  border: none;
  overflow: visible;
}

.gol-demo__viewport canvas {
  width: 100%;
  height: auto;
  display: block;
}

.gol-demo__stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: var(--space-sm, 0.75rem);
  margin: 0;
}

.gol-demo__stats div {
  display: grid;
  gap: var(--space-2xs, 0.25rem);
}

.gol-demo__stats dt {
  font-size: var(--font-size-xs, 0.8125rem);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--color-text-subtle);
}

.gol-demo__stats dd {
  margin: 0;
  font-weight: 600;
}

.gol-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-sm, 0.75rem);
}

.gol-input {
  display: grid;
  gap: var(--space-2xs, 0.25rem);
}

.gol-input label {
  font-size: var(--font-size-sm, 0.875rem);
  font-weight: 600;
  color: var(--color-text-muted);
}

.gol-file {
  display: grid;
  gap: var(--space-xs, 0.5rem);
}

.gol-file span {
  font-size: var(--font-size-sm, 0.875rem);
  color: var(--color-text-muted);
}

.gol-drop {
  border: 1px dashed var(--color-border-muted);
  border-radius: var(--radius-md, 12px);
  padding: var(--space-lg, 1.5rem);
  text-align: center;
  font-size: var(--font-size-sm, 0.875rem);
  color: var(--color-text-muted);
  transition: border 180ms ease, background 180ms ease;
}

.gol-drop:focus-visible,
.gol-drop:hover {
  border-color: color-mix(in srgb, var(--color-primary-500) 38%, transparent);
  background: var(--color-fill-primary-soft);
}

html[data-theme='dark'] .gol-demo__viewport {
  background: none;
  border-color: transparent;
}

html[data-theme='dark'] .gol-demo__stats dt {
  color: var(--color-text-subtle);
}

html[data-theme='dark'] .gol-file span,
html[data-theme='dark'] .gol-drop,
html[data-theme='dark'] .gol-input label,
html[data-theme='dark'] .gol-demo__intro p {
  color: var(--color-text-muted);
}

html[data-theme='dark'] .gol-drop {
  border-color: var(--color-border-muted);
}

@media (max-width: 980px) {
  .gol-demo__layout {
    grid-template-columns: 1fr;
  }
}

:global(.gol-demo__canvas.surface-card) {
  border: none !important;
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}
</style>
